## WASM Workshop

* Create folder `wasmWorkshop`
* Clone quickJs ( <https://github.com/bellard/quickjs> ) in this folder
* Create file `safeEval.c` with the following content:

```C
#include <emscripten.h>
#include <string.h>
#include "./quickjs/quickjs.h"

const char *EMSCRIPTEN_KEEPALIVE safeEval(const char *str)
{

  JSRuntime *runtime = JS_NewRuntime();
  JSContext *ctx = JS_NewContext(runtime);

  JSValue result = JS_Eval(ctx, str, strlen(str), "safeEval", JS_EVAL_TYPE_GLOBAL);

  if (JS_IsException(result))
  {
    JSValue realException = JS_GetException(ctx);
    return JS_ToCString(ctx, realException);
  }

  JSValue json = JS_JSONStringify(ctx, result, JS_UNDEFINED, JS_UNDEFINED);
  JS_FreeValue(ctx, result);
  const char *jsonStr = JS_ToCString(ctx, json);
  JS_FreeContext(ctx);
  JS_FreeRuntime(runtime);

  return jsonStr;
}
```

* Let's compile it by Emscripten in Docker:

```sh
docker run --rm -v $(pwd):/src -t -u $(id -u):$(id -g) emscripten/emsdk emcc \
  -o eval.js \
  ./safeEval.c \
  ./quickjs/quickjs.c ./quickjs/cutils.c ./quickjs/libregexp.c ./quickjs/libbf.c ./quickjs/libunicode.c \
  -DCONFIG_VERSION="\"1.0.0\"" \
  -DEMSCRIPTEN \
  \-lm \
  -Oz \
  -s EXPORTED_FUNCTIONS='["_safeEval"]' \
  -s EXPORT_NAME="SafeEvalModule" \
  -s EXPORTED_RUNTIME_METHODS=ccall,cwrap \
  -s ALLOW_MEMORY_GROWTH=1 \
  -s FILESYSTEM=0 \
  -s MODULARIZE=1
```

* The following files should be generated by the docker command:
  * `eval.js`
  * `eval.wasm`

* Create file `index.html` with the following content:

```html
<!DOCTYPE html>
<html>
  <head>
    <script src="./eval.js"></script>
  </head>
<body>
  <div>Result: <span id="result"></span></div>

  <script>

    async function main() {
      const safeEvalModule = await SafeEvalModule();
      const safeEval = safeEvalModule.cwrap('safeEval', 'string', ['string']);

      const script = `
        function hello(){
            const foo = 'Hello';
            const bar = 'World';
            return foo + ' ' +bar;
        }
        hello();
      `;
      const result = safeEval(script);

      document.getElementById('result').textContent = result;
    }

    main();

  </script>
</body>
</html>
```

* Run command `npx serve .` to serve the page
* Visit <http://localhost:3000>
